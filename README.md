# Solana-MEV

Solana-MEV is a modification of the [upstream Solana validator][upstream] that
handles certain MEV opportunities right in the banking stage of the validator.
Running this validator instead of the upstream one can generate a small amount
of additional income.

**Warning:** This is a proof of concept. [Chorus One][c1] has used it in
production for several weeks, but it is not at a level of polish where it is a
drop-in replacement for the upstream validator.

[upstream]: https://github.com/solana-labs/solana
[c1]:       https://chorus.one/

## Further reading and other media

 * [Decentralizing MEV: An Alternative to Block-Building Marketplaces][talk],
   a talk by Thalita Franklin at Breakpoint 2022.
 * TODO: Add link to whitepaper.

[talk]: https://www.youtube.com/watch?v=nTEnpuDHz3w&t=6198s

## Details

TODO: Write more about how it works.

## Configuration

MEV extraction is enabled by providing the `--mev-config-path` command-line
option to `solana-validator`. Without this option, the validator will run as
usual. `--mev-config-path` should point to a TOML file with the following
schema:

```toml
# File to log details about MEV opportunities and AMM pools to.
log_path = '/path/to/mev.log'

# Programs to watch for interactions. After a user transaction interactis with
# one of these programs, we check for MEV opportunities afterwards.
watched_programs = [
  # Orca Swap v2
  '9W959DqEETiGZocYWCQPaJ6sBmUzgfxXfqGeTEdp3aQP',
  # Orca Swap v1
  'DjVE6JNiYqPL2QXyCUUh8rNjHrbz9hXHNYt99MQ59qw1',
]

# Path to the keypair of the "MEV Authority". This address is the owner of all
# SPL token accounts that are involved in MEV extraction, and it signs all
# transactions generated by the MEV module. For example, if there exists a
# triangular opportunity between the pools USDC/stSOL, stSOL/stETH, stETH/USDC,
# then this address should have an associated token account for USDC, stSOL,
# and stETH. This key is optional, if not provided, we only monitor for
# opportunities but don't extract.
user_authority_path = '/path/to/keypair.json'

[minimum_profit]
# Per token mint address, the minimum profit before we generate a transaction.
# This is to ensure that we donâ€™t execute transactions whose profit is lower
# than the cost of the transaction fees. Note that because we only execute
# transactions when the validator itself is leading, we pay the fee to
# ourselves. However, because half of the fee is burned, we still need a mimum
# of half the transaction fee (5,000 lamports currently). The number is in the
# smallest unit of the token (e.g. lamports for SOL, 1e-6 USDC for USDC).
"So11111111111111111111111111111111111111112" = 2501  # 0.000_002_501 SOL
"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" = 101  # 0.000_101 USDC

# Next are the paths that we want to consider. A path is a sequence of Orca
# pools that should form a cycle.
[[mev_path]]
name = "USDC->wstETH->stSOL->USDC"
path = [
    { pool = "v51xWrRwmFVH6EKe8eZTjgK5E4uC2tzY5sVt5cHbrkG", direction = "BtoA" },
    { pool = "B32UuhPSp6srSBbRTh4qZNjkegsehY9qXTwQgnPWYMZy", direction = "BtoA" },
    { pool = "EfK84vYEKT1PoTJr6fBVKFbyA7ZoftfPo2LQPAJG1exL", direction = "AtoB" },
]

# For every Orca pool involved, we also need to specify its details.
[[orca_account]]
_id = "stSOL/SOL"
address = "71zvJycCiY2JRRwKr27oiu48mFzrstCoP6riGEyCyEB2"
pool_a_account = "HQ2XUmQefvBdpN8nseBSWNP2D1crncodLL73AWnYBiSy"
pool_b_account = "8y8X4JuZn1MckRo5J6rirpr2Dxj1RKQshj7VzuX6dMUw"
pool_mint = "4jjQSgFx33DUb1a7pgPsi3FbtZXDQ94b6QywjNK3NtZw"
pool_fee = "7nxYhYUaD7og4rYce263CCPh9pPTnGixfBtQrXE7UUvZ"

# If we want to also extract MEV and not only monitor for opportunities, we also
# need to provide the addresses of SPL associated token accounts, owned by the
# MEV authority defined earlier, for token A and token B. These are called
# "source" and "destination" respectively, though the rolves can be reversed if
# the pool is used in BtoA swap direction.
source = "..."
destination = "..."
```

## License

Our modifications are licensed under the Apache 2.0 license, just like the
original Solana validator.

As stated in the license, Chorus One is not liable for damages that result from
using this software.
